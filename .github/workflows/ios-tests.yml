name: iOS CI - Testes Automatizados

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Executar Testes
    runs-on: macos-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Select Xcode (flexible auto-detect)
        run: |
          set -e
          echo "Looking for Xcode 26 variants in /Applications..."
          CANDIDATE=$(ls -1 /Applications | grep -Ei 'Xcode.*26' | sort | tail -n 1 || true)
          if [ -n "$CANDIDATE" ]; then
            PATH_TO_XCODE="/Applications/$CANDIDATE/Contents/Developer"
            if [ -d "$PATH_TO_XCODE" ]; then
              echo "Switching to $CANDIDATE"
              sudo xcode-select -switch "$PATH_TO_XCODE"
            else
              echo "Found $CANDIDATE but $PATH_TO_XCODE does not exist; skipping switch."
            fi
          else
            echo "No Xcode 26 found. Looking for generic Xcode.app..."
            if [ -d "/Applications/Xcode.app/Contents/Developer" ]; then
              echo "Switching to /Applications/Xcode.app"
              sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
            else
              echo "No matching Xcode found under /Applications. Current xcode-select path:"
              sudo xcode-select -print-path || true
              echo "Continuing with default Xcode on runner."
            fi
          fi
          echo "xcodebuild -version after switch:"
          xcodebuild -version || true

      - name: Print Xcode version
        run: xcodebuild -version

      - name: Download iOS Platform
        run: xcodebuild -downloadPlatform iOS

      - name: Listar simuladores disponíveis
        run: |
          echo "=== RUNTIMES DISPONÍVEIS ==="
          xcrun simctl list runtimes
          echo " "
          echo "=== DISPOSITIVOS DISPONÍVEIS ==="
          xcrun simctl list devices

      - name: Detectar destino de simulador automaticamente
        id: detect-sim
        run: |
          set -euo pipefail
          echo "Detectando runtime iOS mais recente disponível..."
          # Extrai versões como "iOS 17.4", "iOS 26.0", pega o número e ordena
          LATEST_RUNTIME=$(xcrun simctl list runtimes \
            | grep -Ei 'iOS [0-9]+' \
            | grep -iv 'unavailable' || true)
          if [ -z "$LATEST_RUNTIME" ]; then
            echo "Nenhum runtime iOS listado. Saindo com fallback."
            echo "::set-output name=os::17.4"
            echo "::set-output name=device::iPhone 16"
            exit 0
          fi
          # Pega apenas o número (ex: "17.4" ou "26.0")
          LATEST_RUNTIME_VERSION=$(echo "$LATEST_RUNTIME" \
            | grep -Eo 'iOS [0-9]+(\.[0-9]+)?' \
            | sed 's/iOS //' \
            | sort -V \
            | tail -n1)
          if [ -z "$LATEST_RUNTIME_VERSION" ]; then
            echo "Não consegui determinar versão do runtime; usando fallback 17.4"
            LATEST_RUNTIME_VERSION="17.4"
          fi
          echo "Runtime selecionado: $LATEST_RUNTIME_VERSION"

          echo "Procurando um device iPhone disponível para o runtime $LATEST_RUNTIME_VERSION..."
          # Busca o primeiro iPhone disponível dentro da seção do runtime correspondente
          DEVICE=$(xcrun simctl list devices | awk -v ver="$LATEST_RUNTIME_VERSION" '
            $0 ~ "-- iOS " ver " --" {found=1; next}
            /^--/ { found=0 }
            found && /iPhone/ {
              gsub(/^[ \t]+/, "", $0)
              # remove tudo após o parêntese (UUID/status)
              sub(/\s+\(.*/, "", $0)
              print $0
              exit
            }')
          if [ -z "$DEVICE" ]; then
            echo "Nenhum iPhone encontrado para o runtime $LATEST_RUNTIME_VERSION; tentando qualquer iPhone disponível..."
            DEVICE=$(xcrun simctl list devices | grep -E 'iPhone' | grep -v 'unavailable' | head -n1 | sed 's/ (.*//')
          fi
          if [ -z "$DEVICE" ]; then
            echo "Ainda nada encontrado — aplicando fallback device 'iPhone 16'"
            DEVICE="iPhone 16"
          fi

          echo "Device selecionado: $DEVICE"
          # Exporta outputs para serem usados nos próximos passos
          # note: ::set-output está deprecado em algumas infra; usamos output via file
          echo "::set-output name=os::$LATEST_RUNTIME_VERSION"
          echo "::set-output name=device::$DEVICE"
        shell: bash

      - name: Executar testes unitários
        run: |
          cd Ciganus
          mkdir -p TestResults
          # pega variáveis geradas pelo passo anterior
          DEST_OS="${{ steps.detect-sim.outputs.os }}"
          DEST_DEVICE="${{ steps.detect-sim.outputs.device }}"
          echo "Usando destino: platform=iOS Simulator,name=${DEST_DEVICE},OS=${DEST_OS}"
          xcodebuild test \
            -project Ciganus.xcodeproj \
            -scheme Ciganus \
            -destination "platform=iOS Simulator,name=${DEST_DEVICE},OS=${DEST_OS}" \
            -enableCodeCoverage YES \
            -resultBundlePath ./TestResults/Ciganus.xcresult

      - name: Gerar relatório de cobertura
        if: success()
        run: |
          cd Ciganus
          RESULT="./TestResults/Ciganus.xcresult"
          if [ -d "$RESULT" ]; then
            xcrun xccov view --report --json "$RESULT" > coverage.json || true
            echo "coverage.json gerado em $(pwd)/coverage.json"
          else
            echo "Arquivo .xcresult não encontrado em $RESULT"
            ls -la ./TestResults || true
          fi

      - name: Upload dos resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            Ciganus/TestResults/Ciganus.xcresult
            Ciganus/coverage.json
          retention-days: 7
