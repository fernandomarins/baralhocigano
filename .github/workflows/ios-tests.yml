name: iOS CI - Testes Automatizados

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Executar Testes
    runs-on: macos-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

    - name: Select Xcode (if available)
      run: |
        if [ -d "/Applications/Xcode_26.app/Contents/Developer" ]; then
          echo "Switching to /Applications/Xcode_26.app"
          sudo xcode-select -switch /Applications/Xcode_26.app/Contents/Developer
        elif [ -d "/Applications/Xcode_26.1.1.app/Contents/Developer" ]; then
          echo "Switching to /Applications/Xcode_26.1.1.app"
          sudo xcode-select -switch /Applications/Xcode_26.1.1.app/Contents/Developer
        else
          echo "Desired Xcode not found. Installed Xcodes in /Applications:"
          ls -la /Applications | grep -i Xcode || true
          echo "Current xcode-select path:"
          sudo xcode-select -print-path || true
          echo "Continuing with default Xcode on runner."
        fi

      - name: Print Xcode version
        run: xcodebuild -version

      - name: Download iOS Platform
        run: xcodebuild -downloadPlatform iOS

      - name: Executar testes unitários
        run: |
          cd Ciganus
          # gera um .xcresult previsível em ./TestResults/Ciganus.xcresult
          mkdir -p TestResults
          xcodebuild test \
            -project Ciganus.xcodeproj \
            -scheme Ciganus \
            -destination 'platform=iOS Simulator,name=iPhone 17,OS=26.0' \
            -enableCodeCoverage YES \
            -resultBundlePath ./TestResults/Ciganus.xcresult

      - name: Gerar relatório de cobertura
        if: success()
        run: |
          cd Ciganus
          RESULT="./TestResults/Ciganus.xcresult"
          if [ -d "$RESULT" ]; then
            xcrun xccov view --report --json "$RESULT" > coverage.json || true
            echo "coverage.json gerado em $(pwd)/coverage.json"
          else
            echo "Arquivo .xcresult não encontrado em $RESULT"
            ls -la ./TestResults || true
          fi

      - name: Upload dos resultados
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            Ciganus/TestResults/Ciganus.xcresult
            Ciganus/coverage.json
          retention-days: 30
